"use strict";var LOG_LEVEL="vvv",logger=console.log;console.log=function(){if(arguments.length>=2){var a=arguments[0];switch(LOG_LEVEL){case"production":break;case"v":"errors"==a&&logger.apply(this,arguments);break;case"vv":("errors"==a||"warn"==a)&&logger.apply(this,arguments);break;case"vvv":logger.apply(this,arguments)}}},Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},Array.prototype.remove=function(a){return this.splice(a,1)},Array.prototype.add=function(a,b){if(!b)throw"Trying to add a null variable to array. -oops";return this.splice(a,0,b)},Array.prototype.hasValue=function(a){return-1===this.indexOf(a)?!1:!0},Array.prototype.removeValue=function(a){var b=this.indexOf(a);return-1===b?!1:this.remove(b)},Array.prototype.getByValue=function(a){var b=this.indexOf(a);return-1!==b?this[b]:!1},Array.prototype.getByValueProperty=function(a,b){for(var c=0;c<this.length;c++)if(this[c].hasOwnProperty(a)&&this[c][a]==b)return this[c];return!1},Array.prototype.hasValueProperty=function(a,b){return this.getByValueProperty(a,b)===!1?!1:!0},Array.prototype.valuePropertyIndex=function(a,b){for(var c=0;c<this.length;c++)if(this[c].hasOwnProperty(a)&&this[c][a]===b)return c;return!1};var DISALLOWED_SCREENCAP_URLS=["chrome://newtab/"],ALLOWED_PROTOCOLS=["http:","https:","chrome:"],Parser=function(){this.parser=document.createElement("a")};Parser.prototype={href:function(a){return this.parser.href=a,this},protocol:function(){return this.parser.protocol},hostname:function(){return this.parser.hostname},port:function(){return this.parser.port},pathname:function(){return this.parser.pathname},search:function(){return this.parser.search},hash:function(){return this.parser.hash},host:function(){return this.parser.host}};var stringToInt=function(a){for(var b=0,c="ABCDEFGHIJKLMNOPQRSTUVWXYZ",d=a.toUpperCase(),e=0;e<d.length;e++)b+=c.indexOf(d[e]);return b},tabQuery=function(a,b){return chrome.tabs.query(a,function(c){c&&c.length>0&&c[0].id?b(c[0]):(console.log("WARNING: your tab query failed",a,c),b(!1))})},tabsQuery=function(a,b){return chrome.tabs.query(a,b)},getTab=function(a,b){return chrome.tabs.get(a,b)},tabFocus=function(a,b){chrome.windows.update(b,{focused:!0},function(){chrome.tabs.update(a,{active:!0},function(){})})},sendMessage=function(a,b,c){return chrome.runtime.sendMessage(a,b,c)},lsGet=function(a,b){console.log("notify","local storage  get: ",a),chrome.storage.local.get(String(a),b)},lsSet=function(a,b){console.log("notify","local storage  set: ",a),chrome.storage.local.set(a,b)},lsRemove=function(a,b){if("function"==typeof b){var c=String(a);chrome.storage.local.remove([c,"screencap-"+c,"screencap-url-"+c],b)}else console.log("warn","lsremove callback not defined",b)},setMessageListener=function(a){chrome.runtime.onMessage.addListener(a)},closeTab=function(a){chrome.tabs.remove(a,function(){})},mainController=function(a){a.tabUpdateProperties=["index","windowId","openerTabId","active","url","title","favIconUrl","status"],a.headerMargin=80,a.nodeTopBottomMargin=18,a.bodyXMargin=16,a.nodeMargin=38,a.windowHeight=0,a.windowWidth=0,a.overtabId,a.tabs=[],a.tabIndex={},a.edges={},a.edgesList=[],a.edgesParentIndex={},a.onMessage=function(b){if(console.log("notify","NG message",b),"undefined"==typeof b.id||"number"!=typeof b.id)return void console.log("error","badly formatted message",b);switch(b.message){case"created":console.log("notify","createed",b),a.createTab(b.id);break;case"pre-update":case"pre-update":case"updated":case"favicon":case"activated":console.log("notify","updating the tab",b),a.updateTab(b.id);break;case"screencap":console.log("notify","we have a screencap, virginia",b),a.updateScreenCap(b.id);break;case"removed":console.log("notify","revmoes",b),a.removeTab(b.id);break;default:console.log("warn","unkown message")}a.$apply()},a.tabClose=function(){closeTab(this.tab.id)},a.getAllTabs=function(){lsGet("OVERTAB_TAB_ID",function(b){a.overtabId=b.OVERTAB_TAB_ID;var c=new Parser;tabsQuery({},function(b){console.log("notify","query all tabs",b);for(var d=0;d<b.length;d++){{var e=b[d],f=c.href(e.url).protocol();c.href(e.url).hostname()}"undefined"!=typeof e.id&&-1!==ALLOWED_PROTOCOLS.indexOf(f)&&e.id!=a.overtabId&&"complete"===e.status&&a.addTab(e)}})})},a.getChromeTab=function(a,b){getTab(a,b)},a.tabEdgeSet=function(b,c){if("undefined"==typeof b.openerTabId)return!1;var d=0;a.edges[b.id]=b.openerTabId,"undefined"==typeof a.edgesParentIndex[b.openerTabId]?a.edgesParentIndex[b.openerTabId]=[b.id]:(d=a.edgesParentIndex[b.openerTabId].length++,a.edgesParentIndex[b.openerTabId].push(b.id)),a.edgesList.push([b.id,b.openerTabId,d]),c()},a.tabEdgeRemove=function(b,c){if("undefined"!=typeof typeof a.edges[b]&&delete a.edges[b],"undefined"!=typeof a.edgesParentIndex[b]){for(var d=0;d<a.edgesParentIndex[b].length;d++){var e=a.edgesParentIndex[b][d];delete a.edges[e],delete a.edgesParentIndex[b][d]}delete a.edges[b]}c()},a.createTab=function(b){console.log("notify","add tba"),a.getChromeTab(b,a.addTab)},a.addTab=function(b){if(console.log("notify","getcrhometab: add tab",b),!b)return!1;if(a.tabs.hasValueProperty("id",b.id))return console.log("error","ERROR: trying to add tab for tabId "+b.id+" that already exists in scope.tabs"),!1;var c=new Parser,d=c.href(b.url).hostname();b.searchDomain=d,b.domainInt=stringToInt(d),"undefined"!=typeof b.favIconUrl&&"chrome:"===c.href(b.favIconUrl).protocol()&&delete b.favIconUrl,a.tabEdgeSet(b,a.edgesRender),a.tabs.push(b),setTimeout(function(){window.scrollTo(a.windowWidth,0)},1e3),a.$apply()},a.removeTab=function(b){if(b){var c=a.tabs.valuePropertyIndex("id",b);c!==!1&&(console.log("warn","about to remove tabs:",b,c,a.tabs),a.tabEdgeRemove(b,a.edgesRender),a.tabs.remove(c),a.setWindowSize(),a.edgesRender())}},a.updateLocalTab=function(b,c){var d=new Parser;console.log("warn","about to update local tab",b,c);for(var e=0;e<a.tabUpdateProperties.length;e++){var f=a.tabUpdateProperties[e];("favIconUrl"!=f||"undefined"==typeof b.favIconUrl||"chrome:"!==d.href(b.favIconUrl).protocol())&&"undefined"!=typeof b[f]&&b[f]&&b[f]!==c[f]&&(console.log("notify","updating "+f+" from "+c[f]+" to "+b[f]),c[f]=b[f])}a.edgesRender(),a.$apply()},a.updateScreenCap=function(b){lsGet("screencap-"+b,function(c){if(c.hasOwnProperty("screencap-"+b)){var d=c["screencap-"+b],e=a.tabs.getByValueProperty("id",b);if("undefined"!=typeof e.screencap&&e.screencap!=d||"undefined"==typeof e.screencap||!e.screencap){var f=a.tabs.valuePropertyIndex("id",b);a.tabs[f].screencap=d,a.$apply()}else console.log("warn","couldnt set this records screencap: "+b)}else console.log("warn","we dont have this screen cap record: "+b)})},a.updateTab=function(b){a.getChromeTab(b,function(c){console.log("notify","about to gbvp");{var d=a.tabs.getByValueProperty("id",b);new Parser}return d?c?void a.updateLocalTab(c,d):(console.log("warn","didnt find chrome tab: "+b),!1):(console.log("warn","ERROR: in update didnt find tab "+b),void a.addTab(c))})},a.switchToTab=function(a){tabFocus(a.id,a.windowId)},a.setWindowSize=function(){var b=document.getElementById("node-container").scrollWidth,c=document.getElementById("node-container").scrollHeight;console.log("notify","width",b,"height",c),a.windowWidth=b,a.windowHeight=c},a.edgesRender=function(){window.requestAnimationFrame(function(){a.setWindowSize();for(var b=0;b<a.edgesList.length;b++){var c=a.edgesList[b][0],d=a.edgesList[b][1],e=a.edgeCalc(c,d,b);if(e){var f=angular.element("#line-"+c+"-"+d);angular.element(f).attr("y1",e.y1),angular.element(f).attr("x1",e.x1),angular.element(f).attr("y2",e.y2),angular.element(f).attr("x2",e.x2);var g=Math.abs(.02*e.offset),h=angular.element("#circle-"+c+"-"+d);angular.element(h).attr("cy",e.y2),angular.element(h).attr("cx",e.x2),angular.element(h).attr("r",5+g)}}})},a.edgeCalc=function(b,c,d){var e=angular.element("#"+b).offset(),f=angular.element("#"+c).offset();if(e&&f&&e.left&&e.top&&f.left&&f.top){var g=0,h=a.edgesList[d][2],i=0,j=0,k=0,l=0,m=165,n=180;return f.top>e.top?k=n:f.top<e.top&&(l=n),f.left>e.left?i=m:f.left<e.left?j=m:f.left==e.left&&(g=m-h),{x1:e.left+g+i,y1:e.top+h+k,x2:f.left+j,y2:f.top+l,offset:h}}},a.init=function(){console.log("notify","init"),a.windowHeight=window.innerHeight-a.headerMargin-100,a.windowWidth=window.innerWidth-a.bodyXMargin,a.getAllTabs(),setMessageListener(a.onMessage)}},nodeColor=function(){var a=d3.scale.category20();return{restrict:"A",link:function(b,c,d){var e=d.nodeColor;if("undefined"!=typeof b.tab.domainInt){var f=a(b.tab.domainInt);c.css("border",e+"px solid "+f)}}}},domainExtractionFilter=function(){return function(a){var b,c=a.split("//"),d=c[0];switch(d){case"file:":return b=c[1].split("/"),b.shift(),b.pop(),b.join("/");default:return c[1].split("/")[0]}}},overtabApp=angular.module("overtab",[]);overtabApp.config(["$filterProvider","$compileProvider",function(a,b){overtabApp.register={},overtabApp.register.filter=a.register,b.aHrefSanitizationWhitelist(/^\s*(https?|data|mailto|chrome-extension):/),b.imgSrcSanitizationWhitelist(/^\s*(https?|data|mailto|chrome-extension):/)}]).filter("domainExtraction",domainExtractionFilter).controller("mainController",["$scope","$rootScope","$timeout","$filter",mainController]).directive("nodeColor",nodeColor);